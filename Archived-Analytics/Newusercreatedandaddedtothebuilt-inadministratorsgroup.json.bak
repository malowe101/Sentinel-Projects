{"$schema":"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#","contentVersion":"1.0.0.0","parameters":{"analytic-id":{"defaultValue":"fd161e3c-7562-4946-bd4b-cd6463880f1f","metadata":{"description":"Unique id for the scheduled alert rule"},"minLength":1,"type":"string"},"workspace":{"type":"String"}},"resources":[{"id":"/subscriptions/1c61ccbf-70b3-45a3-a1fb-848ce46d70a6/resourceGroups/cxe-malowe/providers/Microsoft.OperationalInsights/workspaces/malowe2/providers/Microsoft.SecurityInsights/alertRules/fd161e3c-7562-4946-bd4b-cd6463880f1f","name":"fd161e3c-7562-4946-bd4b-cd6463880f1f","etag":"\"80003eef-0000-0100-0000-622618950000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"},{"identifier":"Sid","columnName":"CreatedUserSid"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"HostCustomEntity"}]}],"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Low","query":"SecurityEvent\r| where EventID == 4720\r| where AccountType == 'User'\r| project CreatedUserTime = TimeGenerated, CreatedUserEventID = EventID, CreatedUserActivity = Activity, Computer = toupper(Computer), \rCreatedUser = tolower(TargetAccount), CreatedUserSid = TargetSid, AccountUsedToCreateUser = strcat(SubjectAccount), SidofAccountUsedToCreateUser = SubjectUserSid\r| join (\rSecurityEvent \r| where AccountType == 'User'\r// 4732 - A member was added to a security-enabled local group\r| where EventID == 4732\r//TargetSid is the builin Admins group: S-1-5-32-544\r| where TargetSid == 'S-1-5-32-544'\r| project GroupAddTime = TimeGenerated, GroupAddEventID = EventID, GroupAddActivity = Activity, Computer = toupper(Computer), GroupName = tolower(TargetAccount), \rGroupSid = TargetSid, AccountThatAddedUser = SubjectAccount, SIDofAccountThatAddedUser = SubjectUserSid, CreatedUserSid = MemberSid\r)\ron CreatedUserSid\r//Create User first, then the add to the group.\r| project Computer, CreatedUserTime, CreatedUserEventID, CreatedUserActivity, CreatedUser, CreatedUserSid, GroupAddTime, GroupAddEventID, \rGroupAddActivity, AccountUsedToCreateUser, GroupName, GroupSid, AccountThatAddedUser, SIDofAccountThatAddedUser \r| extend timestamp = CreatedUserTime, AccountCustomEntity = CreatedUser, HostCustomEntity = Computer","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":["Persistence","PrivilegeEscalation"],"displayName":"New user created and added to the built-in administrators group","enabled":true,"description":"Identifies when a user account was created and then added to the builtin Administrators group in the same day.This should be monitored closely and all additions reviewed.","alertRuleTemplateName":"aa1eff90-29d4-49dc-a3ea-b65199f516db","lastModifiedUtc":"2022-03-07T14:37:08.4181737Z"}}]}
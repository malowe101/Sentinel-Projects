{"$schema":"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#","contentVersion":"1.0.0.0","parameters":{"analytic-id":{"defaultValue":"d087ec83-c2bd-447d-8171-dd35d407c852","metadata":{"description":"Unique id for the scheduled alert rule"},"minLength":1,"type":"string"},"workspace":{"type":"String"}},"resources":[{"apiVersion":"2021-10-01","kind":"Scheduled","name":"[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic-id'))]","properties":{"alertRuleTemplateName":"cecdbd4c-4902-403c-8d4b-32eb1efe460b","description":"Identifies a match across various data feeds for domains IOCs related to the Solorigate incident. References: https://blogs.microsoft.com/on-the-issues/2020/12/13/customers-protect-nation-state-cyberattacks/,  https://www.fireeye.com/blog/threat-research/2020/12/evasive-attacker-leverages-solarwinds-supply-chain-compromises-with-sunburst-backdoor.html?1","displayName":"Solorigate Network Beacon","enabled":"true","entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"HostCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]},{"entityType":"DNS","fieldMappings":[{"identifier":"DomainName","columnName":"DNSName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"incidentConfiguration":{"createIncident":"true","groupingConfiguration":{"enabled":"false","groupByEntities":[],"lookbackDuration":"PT5H","matchingMethod":"AllEntities","reopenClosedIncident":"false"}},"query":"let domains = dynamic(['incomeupdate.com','zupertech.com','databasegalore.com','panhardware.com','avsvmcloud.com','digitalcollege.org','freescanonline.com','deftsecurity.com','thedoccloud.com','virtualdataserver.com','lcomputers.com','webcodez.com','globalnetworkissues.com','kubecloud.com','seobundlekit.com','solartrackingsystem.net','virtualwebdata.com']);\r\\n(union isfuzzy=true\r\\n(CommonSecurityLog \r\\n  | parse Message with * '(' DNSName ')' * \r\\n  | where DNSName in~ (domains) or DestinationHostName has_any (domains) or RequestURL has_any(domains)\r\\n  | extend AccountCustomEntity = SourceUserID, HostCustomEntity = DeviceName, IPCustomEntity = SourceIP\r\\n  ),\r\\n(DnsEvents \r\\n  | extend DNSName = Name\r\\n  | where isnotempty(DNSName)\r\\n  | where DNSName has_any (domains)\r\\n  | extend IPCustomEntity = ClientIP\r\\n  ),\r\\n(imDns (domain_has_any=domains)\r\\n  | extend DNSName = DnsQuery\r\\n  | extend IPCustomEntity = SrcIpAddr\r\\n  ),\r\\n(VMConnection \r\\n  | parse RemoteDnsCanonicalNames with * '['' DNSName '']' *\r\\n  | where isnotempty(DNSName)\r\\n  | where DNSName in~ (domains)\r\\n  | extend IPCustomEntity = RemoteIp\r\\n  ),\r\\n(DeviceNetworkEvents \r\\n  | where isnotempty(RemoteUrl) \r\\n  | where RemoteUrl  has_any (domains)  \r\\n  | extend DNSName = RemoteUrl\r\\n  | extend IPCustomEntity = RemoteIP \r\\n  | extend HostCustomEntity = DeviceName \r\\n  ),\r\\n(AzureDiagnostics\r\\n  | where ResourceType == 'AZUREFIREWALLS'\r\\n  | where Category == 'AzureFirewallDnsProxy'\r\\n  | parse msg_s with 'DNS Request: ' ClientIP ':' ClientPort ' - ' QueryID ' ' Request_Type ' ' Request_Class ' ' Request_Name '. ' Request_Protocol ' ' Request_Size ' ' EDNSO_DO ' ' EDNS0_Buffersize ' ' Responce_Code ' ' Responce_Flags ' ' Responce_Size ' ' Response_Duration\r\\n  | where Request_Name has_any (domains)  \r\\n  | extend DNSName = Request_Name\r\\n  | extend IPCustomEntity = ClientIP \r\\n  ),\r\\n(AzureDiagnostics \r\\n  | where ResourceType == 'AZUREFIREWALLS'\r\\n  | where Category == 'AzureFirewallApplicationRule'\r\\n  | parse msg_s with Protocol 'request from ' SourceHost ':' SourcePort 'to ' DestinationHost ':' DestinationPort '. Action:' Action\r\\n  | where isnotempty(DestinationHost)\r\\n  | where DestinationHost has_any (domains)  \r\\n  | extend DNSName = DestinationHost \r\\n  | extend IPCustomEntity = SourceHost\r\\n  ) \r\\n  )","queryFrequency":"PT6H","queryPeriod":"PT6H","severity":"High","suppressionDuration":"PT5H","suppressionEnabled":"false","tactics":["CommandAndControl"],"triggerOperator":"GreaterThan","triggerThreshold":0},"type":"Microsoft.OperationalInsights/workspaces/providers/alertRules"}]}
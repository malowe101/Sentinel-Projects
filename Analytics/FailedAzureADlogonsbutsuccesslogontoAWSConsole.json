{"$schema":"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#","contentVersion":"1.0.0.0","parameters":{"analytic-id":{"defaultValue":"4be07ce6-23aa-482f-851c-88f0b339a4ce","metadata":{"description":"Unique id for the scheduled alert rule"},"minLength":1,"type":"string"},"workspace":{"type":"String"}},"resources":[{"apiVersion":"2021-10-01","kind":"Scheduled","name":"[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic-id'))]","properties":{"alertRuleTemplateName":"643c2025-9604-47c5-833f-7b4b9378a1f5","description":"Identifies a list of IP addresses with a minimum number(defualt of 5) of failed logon attempts to Azure Active Directory.Uses that list to identify any successful AWS Console logons from these IPs within the same timeframe.","displayName":"Failed AzureAD logons but success logon to AWS Console","enabled":"true","entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"incidentConfiguration":{"createIncident":"true","groupingConfiguration":{"enabled":"false","groupByEntities":[],"lookbackDuration":"PT5H","matchingMethod":"AllEntities","reopenClosedIncident":"false"}},"query":"//Adjust this threshold to fit your environment\r\\nlet signin_threshold = 5; \r\\n//Make a list of IPs with AAD signin failures above our threshold\r\\nlet aadFunc = (tableName:string){\r\\nlet Suspicious_signins = \r\\ntable(tableName)\r\\n| where ResultType !in ('0', '50125', '50140')\r\\n| where IPAddress !in ('127.0.0.1', '::1')\r\\n| summarize count() by IPAddress\r\\n| where count_ >  signin_threshold\r\\n| summarize make_set(IPAddress);\r\\nSuspicious_signins\r\\n};\r\\nlet aadSignin = aadFunc('SigninLogs');\r\\nlet aadNonInt = aadFunc('AADNonInteractiveUserSignInLogs');\r\\nlet Suspicious_signins = \r\\nunion isfuzzy=true aadSignin, aadNonInt\r\\n| summarize make_set(set_IPAddress);\r\\n//See if any of those IPs have sucessfully logged into the AWS console\r\\nAWSCloudTrail\r\\n| where EventName =~ 'ConsoleLogin'\r\\n| extend LoginResult = tostring(parse_json(ResponseElements).ConsoleLogin) \r\\n| where LoginResult =~ 'Success'\r\\n| where SourceIpAddress in (Suspicious_signins)\r\\n| extend Reason = 'Multiple failed AAD logins from IP address'\r\\n| extend MFAUsed = tostring(parse_json(AdditionalEventData).MFAUsed)\r\\n| extend User = iif(isempty(UserIdentityUserName), UserIdentityType, UserIdentityUserName) \r\\n| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated) by Reason, LoginResult, EventTypeName, UserIdentityType, User, AWSRegion, SourceIpAddress, UserAgent, MFAUsed\r\\n| extend timestamp = StartTimeUtc, AccountCustomEntity = User, IPCustomEntity = SourceIpAddress","queryFrequency":"P1D","queryPeriod":"P1D","severity":"Medium","suppressionDuration":"PT5H","suppressionEnabled":"false","tactics":["InitialAccess","CredentialAccess"],"triggerOperator":"GreaterThan","triggerThreshold":0},"type":"Microsoft.OperationalInsights/workspaces/providers/alertRules"}]}
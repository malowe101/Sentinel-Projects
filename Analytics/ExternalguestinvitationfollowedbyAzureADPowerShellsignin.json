{"$schema":"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#","contentVersion":"1.0.0.0","parameters":{"analytic-id":{"defaultValue":"acc4c247-aaf7-494b-b5da-17f18863878a","metadata":{"description":"Unique id for the scheduled alert rule"},"minLength":1,"type":"string"},"workspace":{"type":"String"}},"resources":[{"apiVersion":"2021-10-01","kind":"Scheduled","name":"[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic-id'))]","properties":{"alertRuleTemplateName":"acc4c247-aaf7-494b-b5da-17f18863878a","description":"By default guests have capability to invite more external guest users, guests also can do suspicious Azure AD enumeration. This detection look at guestsusers, who have been invited or have invited recently, who also are logging via various PowerShell CLI.Ref : 'https://danielchronlund.com/2021/11/18/scary-azure-ad-tenant-enumeration-using-regular-b2b-guest-accounts/","displayName":"External guest invitation followed by Azure AD PowerShell signin","enabled":"true","incidentConfiguration":{"createIncident":"true","groupingConfiguration":{"enabled":"false","groupByEntities":[],"lookbackDuration":"PT5M","matchingMethod":"AllEntities","reopenClosedIncident":"false"}},"query":"let queryfrequency = 1h;\nlet queryperiod = 1d;\nAuditLogs\n| where TimeGenerated > ago(queryperiod)\n| where OperationName in ('Invite external user', 'Bulk invite users - started (bulk)', 'Invite external user with reset invitation status')\n| extend InitiatedBy = iff(isnotempty(InitiatedBy.user.userPrincipalName), InitiatedBy.user.userPrincipalName, InitiatedBy.app.displayName)\n//| where InitiatedBy has_any ('live.com#', '#EXT#')\n| extend InvitedUser = TargetResources[0].userPrincipalName\n| mv-expand UserToCompare = pack_array(InitiatedBy, InvitedUser)\n| where UserToCompare has_any ('live.com#', '#EXT#')\n| extend\n    parsedUser = replace_string((iff(UserToCompare has 'live.com#', tostring(split(UserToCompare, '#')[1]), tostring(split(UserToCompare, '#EXT#')[0]))), '@', '_'),\n    InvitationTime = TimeGenerated\n| join (\n    (union isfuzzy=true SigninLogs, AADNonInteractiveUserSignInLogs)\n    | where TimeGenerated > ago(queryfrequency)\n    | where UserType != 'Member'\n    | where AppId has_any\n        ('1b730954-1685-4b74-9bfd-dac224a7b894',// Azure Active Directory PowerShell\n         '04b07795-8ddb-461a-bbee-02f9e1bf7b46',// Microsoft Azure CLI\n         '1950a258-227b-4e31-a9cf-717495945fc2',// Microsoft Azure PowerShell\n         'a0c73c16-a7e3-4564-9a95-2bdf47383716',// Microsoft Exchange Online Remote PowerShell\n         'fb78d390-0c51-40cd-8e17-fdbfab77341b',// Microsoft Exchange REST API Based Powershell\n         'd1ddf0e4-d672-4dae-b554-9d5bdfd93547',// Microsoft Intune PowerShell\n         '9bc3ab49-b65d-410a-85ad-de819febfddc',// Microsoft SharePoint Online Management Shell\n         '12128f48-ec9e-42f0-b203-ea49fb6af367',// MS Teams Powershell Cmdlets\n         '23d8f6bd-1eb0-4cc2-a08c-7bf525c67bcd',// Power BI PowerShell\n         '31359c7f-bd7e-475c-86db-fdb8c937548e',// PnP Management Shell\n         '90f610bf-206d-4950-b61d-37fa6fd1b224' // Aadrm Admin Powershell\n        )\n    | summarize arg_min(TimeGenerated, *) by UserPrincipalName\n    | extend\n        parsedUser = replace_string(UserPrincipalName, '@', '_'),\n        SigninTime = TimeGenerated\n    )\n    on parsedUser\n| project InvitationTime, InitiatedBy, OperationName, InvitedUser, SigninTime, SigninCategory = Category1, SigninUserPrincipalName = UserPrincipalName, IPAddress, AppDisplayName, ResourceDisplayName, UserAgent, InvitationAdditionalDetails = AdditionalDetails, InvitationTargetResources = TargetResources","queryFrequency":"PT1H","queryPeriod":"P1D","severity":"Medium","suppressionDuration":"PT5H","suppressionEnabled":"false","tactics":null,"triggerOperator":"GreaterThan","triggerThreshold":0},"type":"Microsoft.OperationalInsights/workspaces/providers/alertRules"}]}
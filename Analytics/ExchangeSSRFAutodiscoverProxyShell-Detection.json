{"$schema":"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#","contentVersion":"1.0.0.0","parameters":{"analytic-id":{"defaultValue":"928ebd34-99c9-43f9-bc8e-a0bbd1368fa4","metadata":{"description":"Unique id for the scheduled alert rule"},"minLength":1,"type":"string"},"workspace":{"type":"String"}},"resources":[{"apiVersion":"2021-10-01","kind":"Scheduled","name":"[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic-id'))]","properties":{"alertRuleTemplateName":"968358d6-6af8-49bb-aaa4-187b3067fb95","description":"This query looks for suspicious request patterns to Exchange servers that fit patterns recentlyblogged about by PeterJson. This exploitation chain utilises an SSRF vulnerability in Exchangewhich eventually allows the attacker to execute arbitrary Powershell on the server. In the examplepowershell can be used to write an email to disk with an encoded attachment containing a shell.Reference: https://peterjson.medium.com/reproducing-the-proxyshell-pwn2own-exploit-49743a4ea9a1","displayName":"Exchange SSRF Autodiscover ProxyShell - Detection","enabled":"true","entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"HostCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]},{"entityType":"AzureResource","fieldMappings":[{"identifier":"ResourceId","columnName":"ResourceCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"incidentConfiguration":{"createIncident":"true","groupingConfiguration":{"enabled":"false","groupByEntities":[],"lookbackDuration":"PT5H","matchingMethod":"AllEntities","reopenClosedIncident":"false"}},"query":"let successCodes = dynamic([200, 302, 401]);\nW3CIISLog\n| where scStatus has_any (successCodes)\n| where ipv4_is_private(cIP) == False\n| where csUriStem hasprefix '/autodiscover/autodiscover.json'\n| project TimeGenerated, cIP, sIP, sSiteName, csUriStem, csUriQuery, Computer, csUserName, _ResourceId, FileUri\n| where (csUriQuery !has 'Protocol' and isnotempty(csUriQuery))\nor (csUriQuery has_any('/mapi/', 'powershell'))\nor (csUriQuery contains '@' and csUriQuery matches regex @'\\.[a-zA-Z]{2,4}?(?:[a-zA-Z]{2,4}\\/)')\nor (csUriQuery contains ':' and csUriQuery matches regex @'\\:[0-9]{2,4}\\/')\n| extend timestamp = TimeGenerated, HostCustomEntity = Computer, IPCustomEntity = cIP, AccountCustomEntity = csUserName, ResourceCustomEntity = _ResourceId, FileCustomEntity = FileUri","queryFrequency":"PT12H","queryPeriod":"PT12H","severity":"High","suppressionDuration":"PT5H","suppressionEnabled":"false","tactics":["InitialAccess"],"triggerOperator":"GreaterThan","triggerThreshold":0},"type":"Microsoft.OperationalInsights/workspaces/providers/alertRules"}]}